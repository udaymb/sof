// SPDX-License-Identifier: BSD-3-Clause
//
// Copyright(c) 2021 Intel Corporation. All rights reserved.
//
// Author: Shriram Shastry <malladi.sastry@linux.intel.com>
//

#include <stdio.h>
#include <stdint.h>
#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <math.h>
#include <cmocka.h>

#include <sof/audio/format.h>
#include <sof/math/trig.h>
#include <sof/common.h>
/* ' Error (max = 0.000059799232976), THD+N  = -89.824298401466635 (dBc)' */
#define CMP_TOLERANCE	0.0001196862
#define _M_PI		3.14159265358979323846	/* pi */
/* Reference table generated by acos(), gcc-4.3.2 */
static const float acos_ref_table[] = {
	3.1415926534682512, 3.0000531002879143, 2.9412577748298645, 2.8960270918905735,
	2.8577985074371099, 2.8240321874618530, 2.7934266068041325, 2.7652091532945633,
	2.7388767916709185, 2.7140803653746843, 2.6905658300966024, 2.6681414637714624,
	2.6466584987938404, 2.6259986199438572, 2.6060659866780043, 2.5867816023528576,
	2.5680795349180698, 2.5499039981514215, 2.5322073306888342, 2.5149484202265739,
	2.4980915319174528, 2.4816053118556738, 2.4654621351510286, 2.4496374558657408,
	2.4341094270348549, 2.4188583977520466, 2.4038666747510433, 2.3891182579100132,
	2.3745986316353083, 2.3602945171296597, 2.3461938071995974, 2.3322853688150644,
	2.3185589388012886, 2.3050050996243954, 2.2916150633245707, 2.2783807571977377,
	2.2652945797890425, 2.2523495275527239, 2.2395390216261148, 2.2268569152802229,
	2.2142974212765694, 2.2018551602959633, 2.1895249988883734, 2.1773021686822176,
	2.1651821155101061, 2.1531605403870344, 2.1412334199994802, 2.1293968763202429,
	2.1176472660154104, 2.1059811022132635, 2.0943950917571783, 2.0828860662877560,
	2.0714510250836611, 2.0600870978087187, 2.0487915109843016, 2.0375616606324911,
	2.0263949912041426, 2.0152891036123037, 2.0042416434735060, 1.9932503849267960,
	1.9823131654411554, 1.9714278969913721, 1.9605926070362329, 1.9498053360730410,
	1.9390642102807760, 1.9283674117177725, 1.9177132192999125, 1.9070998858660460,
	1.8965258020907640, 1.8859893511980772, 1.8754889536648989, 1.8650231678038836,
	1.8545904289931059, 1.8441893383860588, 1.8338185232132673, 1.8234765660017729,
	1.8131621610373259, 1.8028740044683218, 1.7926107998937368, 1.7823712695389986,
	1.7721542436629534, 1.7619584631174803, 1.7517827805131674, 1.7416259888559580,
	1.7314869631081820, 1.7213646043092012, 1.7112577408552170, 1.7011653054505587,
	1.6910861935466528, 1.6810193713754416, 1.6709637474268675, 1.6609182581305504,
	1.6508819069713354, 1.6408536080271006, 1.6308323871344328, 1.6208171751350164,
	1.6108069960027933, 1.6008008290082216, 1.5907976571470499, 1.5807964820414782,
	1.5707963258028030, 1.5607961714267731, 1.5507949963212013, 1.5407918244600296,
	1.5307856574654579, 1.5207754783332348, 1.5107602663338184, 1.5007390454411507,
	1.4907107464969158, 1.4806743953377008, 1.4706289060413837, 1.4605732820928097,
	1.4505064599215984, 1.4404273480176926, 1.4303349126130342, 1.4202280491590500,
	1.4101056903600693, 1.3999666646122932, 1.3898098729550838, 1.3796341903507710,
	1.3694384098052979, 1.3592213839292526, 1.3489818535745144, 1.3387186489999294,
	1.3284304924309254, 1.3181160874664783, 1.3077741302549839, 1.2974033150821924,
	1.2870022244751453, 1.2765694856643677, 1.2661036998033524, 1.2556033022701740,
	1.2450668513774872, 1.2344927676022053, 1.2238794341683388, 1.2132252417504787,
	1.2025284431874752, 1.1917872473952103, 1.1810000464320183, 1.1701647564768791,
	1.1592794880270958, 1.1483422685414553, 1.1373510099947453, 1.1263035498559475,
	1.1151976622641087, 1.1040309928357601, 1.0928011424839497, 1.0815055556595325,
	1.0701416283845901, 1.0587065871804953, 1.0471975617110729, 1.0356115512549877,
	1.0239453874528408, 1.0121957771480083, 1.0003592334687710, 0.9884321130812168,
	0.9764105379581451, 0.9642904847860336, 0.9520676545798779, 0.9397374931722879,
	0.9272952321916819, 0.9147357381880283, 0.9020536318421364, 0.8892431259155273,
	0.8762980736792088, 0.8632118962705135, 0.8499775901436806, 0.8365875538438559,
	0.8230337146669626, 0.8093072846531868, 0.7953988462686539, 0.7812981363385916,
	0.7669940218329430, 0.7524743955582380, 0.7377259787172079, 0.7227342557162046,
	0.7074832264333963, 0.6919551976025105, 0.6761305183172226, 0.6599873416125774,
	0.6435011215507984, 0.6266442332416773, 0.6093853227794170, 0.5916886553168297,
	0.5735131185501814, 0.5548110511153936, 0.5355266667902470, 0.5155940335243940,
	0.4949341546744108, 0.4734511896967888, 0.4510268233716488, 0.4275122880935669,
	0.4027158617973328, 0.3763835001736879, 0.3481660466641188, 0.3175604660063982,
	0.2837941460311413, 0.2455655615776777, 0.2003348786383867, 0.1415395531803370,
	0.0000000000000000
};


/* Reference degree table generated for acos() in the range of [-1:1e-2:1]*/
static const double degree_table[] = {
	-57.2957795262336731, -56.7228217124938965, -56.1498639285564423, -55.5769061148166656,
	-55.0039483308792114, -54.4309905469417572, -53.8580327332019806, -53.2850749492645264,
	-52.7121171653270721, -52.1391593515872955, -51.5662015676498413, -50.9932437539100647,
	-50.4202859699726105, -49.8473281860351562, -49.2743703722953796, -48.7014125883579254,
	-48.1284548044204712, -47.5554969906806946, -46.9825392067432404, -46.4095813930034637,
	-45.8366236090660095, -45.2636658251285553, -44.6907080113887787, -44.1177502274513245,
	-43.5447924435138702, -42.9718346297740936, -42.3988768458366394, -41.8259190320968628,
	-41.2529612481594086, -40.6800034642219543, -40.1070456504821777, -39.5340878665447235,
	-38.9611300826072693, -38.3881722688674927, -37.8152144849300385, -37.2422566711902618,
	-36.6692988872528076, -36.0963411033153534, -35.5233832895755768, -34.9504255056381226,
	-34.3774677217006683, -33.8045099079608917, -33.2315521240234375, -32.6585943102836609,
	-32.0856365263462067, -31.5126787424087524, -30.9397209286689758, -30.3667631447315216,
	-29.7938053607940674, -29.2208475470542908, -28.6478897631168365, -28.0749319493770599,
	-27.5019741654396057, -26.9290163815021515, -26.3560585677623749, -25.7831007838249207,
	-25.2101429998874664, -24.6371851861476898, -24.0642274022102356, -23.4912695884704590,
	-22.9183118045330048, -22.3453540205955505, -21.7723962068557739, -21.1994384229183197,
	-20.6264806389808655, -20.0535228252410889, -19.4805650413036346, -18.9076072275638580,
	-18.3346494436264038, -17.7616916596889496, -17.1887338459491730, -16.6157760620117188,
	-16.0428182780742645, -15.4698604643344879, -14.8969026803970337, -14.3239448666572571,
	-13.7509870827198029, -13.1780292987823486, -12.6050714850425720, -12.0321137011051178,
	-11.4591559171676636, -10.8861981034278870, -10.3132403194904327, -9.7402825057506561,
	-9.1673247218132019, -8.5943669378757477, -8.0214091241359711, -7.4484513401985168,
	-6.8754935562610626, -6.3025357425212860, -5.7295779585838318, -5.1566201448440552,
	-4.5836623609066010, -4.0107045769691467, -3.4377467632293701, -2.8647889792919159,
	-2.2918311953544617, -1.7188733816146851, -1.1459155976772308, -0.5729577839374542,
	0.0000000000000000, 0.5729577839374542, 1.1459155976772308, 1.7188733816146851,
	2.2918311953544617, 2.8647889792919159, 3.4377467632293701, 4.0107045769691467,
	4.5836623609066010, 5.1566201448440552, 5.7295779585838318, 6.3025357425212860,
	6.8754935562610626, 7.4484513401985168, 8.0214091241359711, 8.5943669378757477,
	9.1673247218132019, 9.7402825057506561, 10.3132403194904327, 10.8861981034278870,
	11.4591559171676636, 12.0321137011051178, 12.6050714850425720, 13.1780292987823486,
	13.7509870827198029, 14.3239448666572571, 14.8969026803970337, 15.4698604643344879,
	16.0428182780742645, 16.6157760620117188, 17.1887338459491730, 17.7616916596889496,
	18.3346494436264038, 18.9076072275638580, 19.4805650413036346, 20.0535228252410889,
	20.6264806389808655, 21.1994384229183197, 21.7723962068557739, 22.3453540205955505,
	22.9183118045330048, 23.4912695884704590, 24.0642274022102356, 24.6371851861476898,
	25.2101429998874664, 25.7831007838249207, 26.3560585677623749, 26.9290163815021515,
	27.5019741654396057, 28.0749319493770599, 28.6478897631168365, 29.2208475470542908,
	29.7938053607940674, 30.3667631447315216, 30.9397209286689758, 31.5126787424087524,
	32.0856365263462067, 32.6585943102836609, 33.2315521240234375, 33.8045099079608917,
	34.3774677217006683, 34.9504255056381226, 35.5233832895755768, 36.0963411033153534,
	36.6692988872528076, 37.2422566711902618, 37.8152144849300385, 38.3881722688674927,
	38.9611300826072693, 39.5340878665447235, 40.1070456504821777, 40.6800034642219543,
	41.2529612481594086, 41.8259190320968628, 42.3988768458366394, 42.9718346297740936,
	43.5447924435138702, 44.1177502274513245, 44.6907080113887787, 45.2636658251285553,
	45.8366236090660095, 46.4095813930034637, 46.9825392067432404, 47.5554969906806946,
	48.1284548044204712, 48.7014125883579254, 49.2743703722953796, 49.8473281860351562,
	50.4202859699726105, 50.9932437539100647, 51.5662015676498413, 52.1391593515872955,
	52.7121171653270721, 53.2850749492645264, 53.8580327332019806, 54.4309905469417572,
	55.0039483308792114, 55.5769061148166656, 56.1498639285564423, 56.7228217124938965,
	57.2957795262336731
};

static void test_math_trig_acos_16b_fixed(void **state)
{
	(void)state;
	double u;
	double v;
	int indx;
	int b_i;

	for (indx = 0; indx < ARRAY_SIZE(degree_table); ++indx) {
		/* convert angle unit degrees to radians */
		/* angleInRadians = pi/180 * angleInDegrees & const Q2.30 format */
		u = (0.017453292519943295 * (double)degree_table[indx] * 0x40000000);
		v = fabs(u);
		u = (v >= 0.5) ? floor(u + 0.5) : 0.0;
		b_i = (int)u;

		float r = Q_CONVERT_QTOF(acos_fixed_16b(b_i), 13);
		float diff = fabsf(acos_ref_table[indx] - r);

		if (diff > CMP_TOLERANCE) {
			printf("%s: diff for %.16f deg = %.10f\n", __func__,
			       ((180 / _M_PI) * b_i) / (1 << 30), diff);
		}

		assert_true(diff <= CMP_TOLERANCE);
	}
}

int main(void)
{
	const struct CMUnitTest tests[] = {
		cmocka_unit_test(test_math_trig_acos_16b_fixed)
	};

	cmocka_set_message_output(CM_OUTPUT_TAP);

	return cmocka_run_group_tests(tests, NULL, NULL);
}
