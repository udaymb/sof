// SPDX-License-Identifier: BSD-3-Clause
//
// Copyright(c) 2018 Intel Corporation. All rights reserved.
//
// Author: Shriram Shastry <malladi.sastry@linux.intel.com>

#include <stdio.h>
#include <stdint.h>
#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <math.h>
#include <cmocka.h>

#include <sof/audio/format.h>
#include <sof/math/trig.h>
#include <sof/common.h>
/* 'Error (max = 0.000059799232976), THD+N  = -89.824298401466635 (dBc) */
#define CMP_TOLERANCE	0.0001152158
#define _M_PI		3.14159265358979323846	/* pi */
/* Reference table generated by asin(), gcc-4.3.2 */
static const float asin_ref_table[] = {
	-1.5707963258028030, -1.4292567726224661, -1.3704614471644163, -1.3252307642251253,
	-1.2870021797716618, -1.2532358597964048, -1.2226302791386843, -1.1944128256291151,
	-1.1680804640054703, -1.1432840377092361, -1.1197695024311543, -1.0973451361060143,
	-1.0758621711283922, -1.0552022922784090, -1.0352696590125561, -1.0159852746874094,
	-0.9972832072526217, -0.9791076704859734, -0.9614110030233860, -0.9441520925611258,
	-0.9272952042520046, -0.9108089841902256, -0.8946658074855804, -0.8788411282002926,
	-0.8633130993694067, -0.8480620700865984, -0.8330703470855951, -0.8183219302445650,
	-0.8038023039698601, -0.7894981894642115, -0.7753974795341492, -0.7614890411496162,
	-0.7477626111358404, -0.7342087719589472, -0.7208187356591225, -0.7075844295322895,
	-0.6944982521235943, -0.6815531998872757, -0.6687426939606667, -0.6560605876147747,
	-0.6435010936111212, -0.6310588326305151, -0.6187286712229252, -0.6065058410167694,
	-0.5943857878446579, -0.5823642127215862, -0.5704370923340321, -0.5586005486547947,
	-0.5468509383499622, -0.5351847745478153, -0.5235987640917301, -0.5120897386223078,
	-0.5006546974182129, -0.4892907701432705, -0.4779951833188534, -0.4667653329670429,
	-0.4555986635386944, -0.4444927759468555, -0.4334453158080578, -0.4224540572613478,
	-0.4115168377757072, -0.4006315693259239, -0.3897962793707848, -0.3790090084075928,
	-0.3682678826153278, -0.3575710840523243, -0.3469168916344643, -0.3363035582005978,
	-0.3257294744253159, -0.3151930235326290, -0.3046926259994507, -0.2942268401384354,
	-0.2837941013276577, -0.2733930107206106, -0.2630221955478191, -0.2526802383363247,
	-0.2423658333718777, -0.2320776768028736, -0.2218144722282887, -0.2115749418735504,
	-0.2013579159975052, -0.1911621354520321, -0.1809864528477192, -0.1708296611905098,
	-0.1606906354427338, -0.1505682766437531, -0.1404614131897688, -0.1303689777851105,
	-0.1202898658812046, -0.1102230437099934, -0.1001674197614193, -0.0901219304651022,
	-0.0800855793058872, -0.0700572803616524, -0.0600360594689846, -0.0500208474695683,
	-0.0400106683373451, -0.0300045013427734, -0.0200013294816017, -0.0100001543760300,
	0.0000000000000000, 0.0100001543760300, 0.0200013294816017, 0.0300045013427734,
	0.0400106683373451, 0.0500208474695683, 0.0600360594689846, 0.0700572803616524,
	0.0800855793058872, 0.0901219304651022, 0.1001674197614193, 0.1102230437099934,
	0.1202898658812046, 0.1303689777851105, 0.1404614131897688, 0.1505682766437531,
	0.1606906354427338, 0.1708296611905098, 0.1809864528477192, 0.1911621354520321,
	0.2013579159975052, 0.2115749418735504, 0.2218144722282887, 0.2320776768028736,
	0.2423658333718777, 0.2526802383363247, 0.2630221955478191, 0.2733930107206106,
	0.2837941013276577, 0.2942268401384354, 0.3046926259994507, 0.3151930235326290,
	0.3257294744253159, 0.3363035582005978, 0.3469168916344643, 0.3575710840523243,
	0.3682678826153278, 0.3790090084075928, 0.3897962793707848, 0.4006315693259239,
	0.4115168377757072, 0.4224540572613478, 0.4334453158080578, 0.4444927759468555,
	0.4555986635386944, 0.4667653329670429, 0.4779951833188534, 0.4892907701432705,
	0.5006546974182129, 0.5120897386223078, 0.5235987640917301, 0.5351847745478153,
	0.5468509383499622, 0.5586005486547947, 0.5704370923340321, 0.5823642127215862,
	0.5943857878446579, 0.6065058410167694, 0.6187286712229252, 0.6310588326305151,
	0.6435010936111212, 0.6560605876147747, 0.6687426939606667, 0.6815531998872757,
	0.6944982521235943, 0.7075844295322895, 0.7208187356591225, 0.7342087719589472,
	0.7477626111358404, 0.7614890411496162, 0.7753974795341492, 0.7894981894642115,
	0.8038023039698601, 0.8183219302445650, 0.8330703470855951, 0.8480620700865984,
	0.8633130993694067, 0.8788411282002926, 0.8946658074855804, 0.9108089841902256,
	0.9272952042520046, 0.9441520925611258, 0.9614110030233860, 0.9791076704859734,
	0.9972832072526217, 1.0159852746874094, 1.0352696590125561, 1.0552022922784090,
	1.0758621711283922, 1.0973451361060143, 1.1197695024311543, 1.1432840377092361,
	1.1680804640054703, 1.1944128256291151, 1.2226302791386843, 1.2532358597964048,
	1.2870021797716618, 1.3252307642251253, 1.3704614471644163, 1.4292567726224661,
	1.5707963258028030,
};

/* Reference degree table generated for asin() in the range of [-1:1e-2:1]*/
static const double degree_table[] = {
	-57.2957795262336731, -56.7228217124938965, -56.1498639285564423, -55.5769061148166656,
	-55.0039483308792114, -54.4309905469417572, -53.8580327332019806, -53.2850749492645264,
	-52.7121171653270721, -52.1391593515872955, -51.5662015676498413, -50.9932437539100647,
	-50.4202859699726105, -49.8473281860351562, -49.2743703722953796, -48.7014125883579254,
	-48.1284548044204712, -47.5554969906806946, -46.9825392067432404, -46.4095813930034637,
	-45.8366236090660095, -45.2636658251285553, -44.6907080113887787, -44.1177502274513245,
	-43.5447924435138702, -42.9718346297740936, -42.3988768458366394, -41.8259190320968628,
	-41.2529612481594086, -40.6800034642219543, -40.1070456504821777, -39.5340878665447235,
	-38.9611300826072693, -38.3881722688674927, -37.8152144849300385, -37.2422566711902618,
	-36.6692988872528076, -36.0963411033153534, -35.5233832895755768, -34.9504255056381226,
	-34.3774677217006683, -33.8045099079608917, -33.2315521240234375, -32.6585943102836609,
	-32.0856365263462067, -31.5126787424087524, -30.9397209286689758, -30.3667631447315216,
	-29.7938053607940674, -29.2208475470542908, -28.6478897631168365, -28.0749319493770599,
	-27.5019741654396057, -26.9290163815021515, -26.3560585677623749, -25.7831007838249207,
	-25.2101429998874664, -24.6371851861476898, -24.0642274022102356, -23.4912695884704590,
	-22.9183118045330048, -22.3453540205955505, -21.7723962068557739, -21.1994384229183197,
	-20.6264806389808655, -20.0535228252410889, -19.4805650413036346, -18.9076072275638580,
	-18.3346494436264038, -17.7616916596889496, -17.1887338459491730, -16.6157760620117188,
	-16.0428182780742645, -15.4698604643344879, -14.8969026803970337, -14.3239448666572571,
	-13.7509870827198029, -13.1780292987823486, -12.6050714850425720, -12.0321137011051178,
	-11.4591559171676636, -10.8861981034278870, -10.3132403194904327, -9.7402825057506561,
	-9.1673247218132019, -8.5943669378757477, -8.0214091241359711, -7.4484513401985168,
	-6.8754935562610626, -6.3025357425212860, -5.7295779585838318, -5.1566201448440552,
	-4.5836623609066010, -4.0107045769691467, -3.4377467632293701, -2.8647889792919159,
	-2.2918311953544617, -1.7188733816146851, -1.1459155976772308, -0.5729577839374542,
	0.0000000000000000, 0.5729577839374542, 1.1459155976772308, 1.7188733816146851,
	2.2918311953544617, 2.8647889792919159, 3.4377467632293701, 4.0107045769691467,
	4.5836623609066010, 5.1566201448440552, 5.7295779585838318, 6.3025357425212860,
	6.8754935562610626, 7.4484513401985168, 8.0214091241359711, 8.5943669378757477,
	9.1673247218132019, 9.7402825057506561, 10.3132403194904327, 10.8861981034278870,
	11.4591559171676636, 12.0321137011051178, 12.6050714850425720, 13.1780292987823486,
	13.7509870827198029, 14.3239448666572571, 14.8969026803970337, 15.4698604643344879,
	16.0428182780742645, 16.6157760620117188, 17.1887338459491730, 17.7616916596889496,
	18.3346494436264038, 18.9076072275638580, 19.4805650413036346, 20.0535228252410889,
	20.6264806389808655, 21.1994384229183197, 21.7723962068557739, 22.3453540205955505,
	22.9183118045330048, 23.4912695884704590, 24.0642274022102356, 24.6371851861476898,
	25.2101429998874664, 25.7831007838249207, 26.3560585677623749, 26.9290163815021515,
	27.5019741654396057, 28.0749319493770599, 28.6478897631168365, 29.2208475470542908,
	29.7938053607940674, 30.3667631447315216, 30.9397209286689758, 31.5126787424087524,
	32.0856365263462067, 32.6585943102836609, 33.2315521240234375, 33.8045099079608917,
	34.3774677217006683, 34.9504255056381226, 35.5233832895755768, 36.0963411033153534,
	36.6692988872528076, 37.2422566711902618, 37.8152144849300385, 38.3881722688674927,
	38.9611300826072693, 39.5340878665447235, 40.1070456504821777, 40.6800034642219543,
	41.2529612481594086, 41.8259190320968628, 42.3988768458366394, 42.9718346297740936,
	43.5447924435138702, 44.1177502274513245, 44.6907080113887787, 45.2636658251285553,
	45.8366236090660095, 46.4095813930034637, 46.9825392067432404, 47.5554969906806946,
	48.1284548044204712, 48.7014125883579254, 49.2743703722953796, 49.8473281860351562,
	50.4202859699726105, 50.9932437539100647, 51.5662015676498413, 52.1391593515872955,
	52.7121171653270721, 53.2850749492645264, 53.8580327332019806, 54.4309905469417572,
	55.0039483308792114, 55.5769061148166656, 56.1498639285564423, 56.7228217124938965,
	57.2957795262336731
};

static void test_math_trig_asin_16b_fixed(void **state)
{
	(void)state;

	double u;
	double v;
	int indx;
	int b_i;

	for (indx = 0; indx < ARRAY_SIZE(degree_table); ++indx) {
		/* convert angle unit degrees to radians */
		/* angleInRadians = pi/180 * angleInDegrees & const Q2.30 format */
		u = (0.017453292519943295 * (double)degree_table[indx] * 0x40000000);
		v = fabs(u);
		u = (v >= 0.5) ? floor(u + 0.5) : 0.0;
		b_i = (int)u;

		float r = Q_CONVERT_QTOF(asin_fixed_16b(b_i), 13);
		float diff = fabsf(asin_ref_table[indx] - r);

		if (diff > CMP_TOLERANCE) {
			printf("%s: diff for %.16f deg = %.10f\n", __func__,
			       ((180 / _M_PI) * b_i) / (1 << 30), diff);
		}

		assert_true(diff <= CMP_TOLERANCE);
	}
}

int main(void)
{
	const struct CMUnitTest tests[] = {
		cmocka_unit_test(test_math_trig_asin_16b_fixed)
	};

	cmocka_set_message_output(CM_OUTPUT_TAP);

	return cmocka_run_group_tests(tests, NULL, NULL);
}
